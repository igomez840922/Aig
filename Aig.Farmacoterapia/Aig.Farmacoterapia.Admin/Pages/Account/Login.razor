@page "/login"
@using Aig.Farmacoterapia.Infrastructure.Identity
@using Blazored.FluentValidation
@using Microsoft.AspNetCore.Identity
@using Aig.Farmacoterapia.Application.Common.Middleware
@using Aig.Farmacoterapia.Application.Login.Model
@using Aig.Farmacoterapia.Domain.Interfaces
@layout AccountLayout
@attribute [AllowAnonymous]
@inject NavigationManager navigationManager
@inject UserManager<ApplicationUser> userManager
@inject SignInManager<ApplicationUser> signInManager
@*@inject ISystemLogger systemLogger;*@
@inject IJSRuntime JS

<DateRangePicker Drops="DropsType.Up" />

<div class="kt-login__signin">
    <div class="kt-login__head">
        <h3 class="kt-login__title">Entrar en su cuenta</h3>
    </div>
    <div class="kt-login__form">
        
        <EditForm Model="@LoginRequest" OnValidSubmit="@SubmitValidForm">
            <FluentValidationValidator />
            <div class="input-group">
                <label class="text-danger">@Error</label>
            </div>
            <div class="form-group is-invalid">
                <InputText class="form-control" type="text" autocomplete="off" placeholder="Usuario"
                           name="UserName" @bind-Value="LoginRequest.UserName"/>
                <div class="error invalid-feedback">
                    <ValidationMessage For="@(() => LoginRequest.UserName)"/>
                </div>
            </div>
            <div class="form-group validate is-invalid">
                <InputText class="form-control" type="password" autocomplete="off" placeholder="Contraseña"
                           name="Password" @bind-Value="LoginRequest.Password"/>
                <div class="error invalid-feedback">
                    <ValidationMessage For="@(() => LoginRequest.Password)"/>
                </div>
            </div>
            <div class="row kt-login__extra">
                <div class="col">
                    <label class="kt-checkbox">
                        <InputCheckbox type="checkbox" name="remember" @bind-Value="LoginRequest.RememberMe"/>
                        Recuerdame
                        <span></span>
                    </label>
                </div>
            </div>
            <div class="kt-login__actions">
                <button id="kt_login_signin_submit" class="btn btn-brand btn-pill kt-login__btn-primary"
                        type="submit">Entrar</button>
            </div>
        </EditForm>

    </div>
</div>


@code{

    [CascadingParameter]
    protected Task<AuthenticationState> AuthStat { get; set; }
    LoginModel LoginRequest { get; set; } = new LoginModel();
    string Error { get; set; } = string.Empty;
    string InvalidUser { get; set; } =  "Usuario o contraseña no válidos";
    string LockedUser{ get; set; } =  "Su cuenta ha sido bloqueada";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var user = (await AuthStat).User;
        if (user.Identity is {IsAuthenticated: true })
            navigationManager.NavigateTo("./");
    }
    private async Task SubmitValidForm()
    {
        try
        {
            var usr = await userManager.FindByNameAsync(LoginRequest.UserName);
            if (usr == null){
                Error = this.InvalidUser;
                return;
            }
            if (await signInManager.CanSignInAsync(usr))
            {
                var result = await signInManager.CheckPasswordSignInAsync(usr, LoginRequest.Password, true);
                if (result.Succeeded)
                {
                    var key = BlazorCookieLoginMiddleware<ApplicationUser>.AnnounceLogin(LoginRequest);
                    navigationManager.NavigateTo($"./login?key={key}", true);
                }
                else
                    Error = this.InvalidUser;
            }
            else
                Error = this.LockedUser;

        }
        catch (Exception ex){Error = ex.Message;}
    }
   
}
