@page "/marker/list"
@*@layout null*@
@using Aig.Farmacoterapia.Admin.Components
@using Aig.Farmacoterapia.Admin.Components.Maker
@using Aig.Farmacoterapia.Application.Medicament.Model
@using Aig.Farmacoterapia.Domain.Common
@using Aig.Farmacoterapia.Domain.Entities.Enums
@using System.Linq
@using Aig.Farmacoterapia.Domain.Entities
@using Aig.Farmacoterapia.Domain.Interfaces
@using System.Globalization
@attribute [Authorize]
@inject IUnitOfWork _unitOfWork;
@inject ISystemLogger _systemLogger;
@inject IMakerRepository _repository;
@inject IJSRuntime JS

<div class="kt-portlet__head kt-portlet__head--lg">
    <div class="kt-portlet__head-label">
        <span class="kt-portlet__head-icon">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1" class="kt-svg-icon">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M18.4246212,12.6464466 L21.2530483,9.81801948 C21.4483105,9.62275734 21.764893,9.62275734 21.9601551,9.81801948 L22.6672619,10.5251263 C22.862524,10.7203884 22.862524,11.0369709 22.6672619,11.232233 L19.8388348,14.0606602 C19.6435726,14.2559223 19.3269901,14.2559223 19.131728,14.0606602 L18.4246212,13.3535534 C18.2293591,13.1582912 18.2293591,12.8417088 18.4246212,12.6464466 Z M3.22182541,17.9497475 L13.1213203,8.05025253 C13.5118446,7.65972824 14.1450096,7.65972824 14.5355339,8.05025253 L15.9497475,9.46446609 C16.3402718,9.85499039 16.3402718,10.4881554 15.9497475,10.8786797 L6.05025253,20.7781746 C5.65972824,21.1686989 5.02656326,21.1686989 4.63603897,20.7781746 L3.22182541,19.363961 C2.83130112,18.9734367 2.83130112,18.3402718 3.22182541,17.9497475 Z" fill="#000000" opacity="0.3" />
                        <path d="M12.3890873,1.28248558 L12.3890873,1.28248558 C15.150511,1.28248558 17.3890873,3.52106183 17.3890873,6.28248558 L17.3890873,10.7824856 C17.3890873,11.058628 17.1652297,11.2824856 16.8890873,11.2824856 L12.8890873,11.2824856 C12.6129449,11.2824856 12.3890873,11.058628 12.3890873,10.7824856 L12.3890873,1.28248558 Z" fill="#000000" transform="translate(14.889087, 6.282486) rotate(-45.000000) translate(-14.889087, -6.282486) " />
                    </g>
                </svg>
        </span>
        <h3 class="kt-portlet__head-title">
            Fabricantes
        </h3>
    </div>
    <div class="kt-portlet__head-toolbar">
        <div class="kt-portlet__head-wrapper">
            <div class="kt-portlet__head-actions">
                <button disabled="@(loading)"  href="#" class="btn btn-outline-brand btn-square" @onclick="() => OnEdit(0)" data-toggle="modal" data-target="#modal_createedit">
                    <i class="la la-plus"></i>
                    Nuevo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="kt-portlet__body">

    <EditForm Model="this" OnValidSubmit="OnSearch" class="kt-form kt-form--fit kt-margin-b-20">

        <div class="row kt-margin-b-20">
            <div class="col-lg-4 kt-margin-b-10-tablet-and-mobile">
                <label>Nombre:</label>
                <input type="text" @bind-value="searchString" class="form-control kt-input" placeholder="" data-col-index="0">
            </div>
          
            <div class="col-lg-5 kt-margin-b-10-tablet-and-mobile">
                <div class="row" style="margin-top: 23px;">
                    <div class="col-lg-12" style="margin-top: 3px;">
                        <button disabled="@(loading)"  type="submit" class="btn btn-outline-brand btn-square" style="padding: 5px 10px 5px 10px;">
                            <span>
                                <i class="la la-search"></i>
                                <span>Buscar</span>
                            </span>
                        </button>
                        &nbsp;&nbsp;
                        <button disabled="@(loading)" type="button" @onclick="() => OnReset()" class="btn btn-outline-brand btn-square" style="padding: 5px 10px 5px 10px;">
                            <span>
                                <i class="la la-close"></i>
                                <span>Eliminar</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>

 <div class="table-responsive">
        <MudTable @ref="table" Striped="true"  LoadingProgressColor="Color.Primary" Dense="true" Hover="true" ServerData="@(new Func<TableState, Task<TableData<AigFabricante>>>(DoFetchData))" Breakpoint="Breakpoint.Sm">

            <HeaderContent>
                <MudTh style="width:150px;"><MudTableSortLabel  InitialDirection="SortDirection.Ascending"  T="AigFabricante" SortLabel="name">Nombre</MudTableSortLabel></MudTh>
                <MudTh style="width:150px;">Dirección</MudTh>
                <MudTh style="width:10px;">Correo</MudTh>
                <MudTh style="width:20px;">País</MudTh>
                <MudTh style="width:30px;">Creado</MudTh>
                <MudTh style="width:20px;">Creado por</MudTh>
                <MudTh style="width:30px;">Última modificación</MudTh>
                <MudTh style="width:20px;">Modificado por</MudTh>
                <MudTh style="width:5px;"></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
                <MudTd DataLabel="Dirección">@context.Direccion</MudTd>
                <MudTd DataLabel="Correo">@context.Correo</MudTd>
                <MudTd DataLabel="País">@(context.Pais!=null ? context.Pais.Nombre: "-")</MudTd>
               
                <MudTd DataLabel="Creado">@(string.Format("{0:dd/MM/yyyy}",context.Created))</MudTd>
                <MudTd DataLabel="Creado por">@context.CreatedBy</MudTd>
                <MudTd DataLabel="Última modificación">@(context.LastModified!=null ?string.Format("{0:dd/MM/yyyy}",context.LastModified) : "-")</MudTd>
                <MudTd DataLabel="Modificado por">@(context.LastModifiedBy!=null ? context.LastModifiedBy : "-")</MudTd>
                <MudTd>
                    <span class="dropdown">
                        <button disabled="@(loading)"  href="#" class="btn btn-sm btn-clean btn-icon btn-icon-md" data-toggle="dropdown" aria-expanded="true">
                             <i class="flaticon-more-1 kt-font-brand"></i>
                        </button>
                        <span class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#" @onclick="() => OnEdit(context.Id)" data-toggle="modal" data-target="#modal_createedit" >
                                <i class="la la-edit"></i> Editar
                            </a> 
                            <a class="dropdown-item" href="#" @onclick="() => OnDelete(context)" data-toggle="modal">
                                <i class="la la-trash"></i> 
                                Eliminar
                            </a> 
                        </span>
                    </span>
                </MudTd>
            </RowTemplate>
           
            <NoRecordsContent>
                <MudText>No se encontraron elementos</MudText>
            </NoRecordsContent>
             <LoadingContent>
            <MudText>Cargando...</MudText>
        </LoadingContent>
            <PagerContent>
                <MudTablePager HorizontalAlignment="HorizontalAlignment.Center" Class="primary" InfoFormat="{first_item}-{last_item} de {all_items}" PageSizeOptions="new int[] {10, 25, 50, 100, 250 }" RowsPerPageString="Filas" />
            </PagerContent>
        </MudTable>
    </div>

</div>

@if (addEditDialogIsOpen)
{
    <AddEdit ModelData="@modelData" OnClose="@OnEventAddEditClose"></AddEdit>
}

@if(deleteDialogIsOpen)
{
   <DeleteConfirmDialog Caption="Eliminar"
                   Message="¿Confirma que desea de eliminar el artículo?"
                   OnClose="@OnDeleteDialogClose">
    </DeleteConfirmDialog>
}

@code {

    private MudTable<AigFabricante> table;
    private static IEnumerable<AigFabricante> List { get; set; }
    private string searchString;
    protected AigFabricante modelData;
    protected bool addEditDialogIsOpen = false;
    protected bool deleteDialogIsOpen = false;
    protected bool loading = false;
    protected async override Task OnInitializedAsync()
    {
        try
        {
            searchString= string.Empty;
        }
        catch (Exception ex)
        {
            _systemLogger.Error(ex.Message);
        }

        base.OnInitialized();
    }

       private async Task RefresView()
    {
        await this.InvokeAsync(StateHasChanged);
    }
    private async Task<TableData<AigFabricante>> DoFetchData(TableState state)
    {
        var result = new TableData<AigFabricante>();
        try
        {

            loading = true;
            await RefresView();
            var sorting = new List<SortingOption>();
            var filters = new List<FilteringOption>();
            if (state.SortDirection != SortDirection.None)
            {
                var sortDirection = state.SortDirection == SortDirection.Descending ? SortingDirection.DESC : SortingDirection.ASC;
                sorting = new() { new SortingOption { Field = state.SortLabel, Direction = sortDirection } };
            }
            if (!string.IsNullOrEmpty(searchString))
                filters.Add(new FilteringOption { Field = "term", Operator = FilteringOperator.Contains, Value = searchString.Trim() });

            var args = new PageSearchArgs()
                {
                    PageIndex = state.Page + 1,
                    PageSize = state.PageSize,
                    SortingOptions = sorting,
                    FilteringOptions = filters
                };
            var paginatedResult = await _repository.ListAsync(args);
            List = paginatedResult.Data;
            return new TableData<AigFabricante>() { TotalItems = paginatedResult.TotalCount, Items = paginatedResult.Data };

        }
        catch (Exception ex)
        {
            _systemLogger.Error(ex.Message);
        }
        finally { loading = false; await RefresView(); }
        return result;

    }

    private void OnSearch(string text)
    {
        table.ReloadServerData();
    }
    private void OnSearch()
    {
        table.ReloadServerData();
    }
    private void OnReset()
    {
        searchString = string.Empty;
        table.ReloadServerData();
    }

   private async Task OnEdit(long id)
    {
        var result = await _unitOfWork.Repository<AigFabricante>().GetByIdAsync(id);
        if (result == null)
            result = new AigFabricante();

        modelData = result;
        addEditDialogIsOpen = true;
        StateHasChanged();
    }

    private async Task OnEventAddEditClose(long id)
    {
        addEditDialogIsOpen = false;
        if (id>0)
            table.ReloadServerData();
    }
    private async Task OnDelete(AigFabricante data)
    {
        modelData = data;
        deleteDialogIsOpen = true;
    }
    private async Task OnDeleteDialogClose(bool isOk)
    {        
        if (isOk)
        {
            await _unitOfWork.Repository<AigFabricante>().DeleteAsync(modelData);
            if (_unitOfWork.Commit()){
                await JS.InvokeVoidAsync("ShowMessage", "Elemento eliminado correctamente");
                await JS.InvokeVoidAsync("OpenCloseModal", "#btnCloseDeleteModal");
                await table.ReloadServerData();
            }
            else
               await JS.InvokeVoidAsync("ShowError", "DataDeleteError");
        }
        deleteDialogIsOpen = false;
    }

}